---
title: "Naomi Model Workflow Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Naomi Model Workflow Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







```r
library(naomi)
library(tidyverse)
library(sf)
```

# 0. Prepare webtool GeoJSON input

The MVP version of Naomi web tool allows upload of a single GeoJSON file for
specifying the area hierarchy. This preprocessing step joins the area tables
into a single long format dataset and saves as a GeoJSON for upload to the
web tool.



# 1. (Up)Load data inputs

Area hierarchy and boundaries


```r
area_merged <- read_sf(system.file("extdata/demo_areas.geojson", package = "naomi"))
```

Population data


```r
pop_agesex <- read_csv(system.file("extdata/demo_population_agesex.csv", package = "naomi"))
```

Survey data


```r
survey_hiv_indicators <- read_csv(system.file("extdata/demo_survey_hiv_indicators.csv", package = "naomi"))
```

Programme data



```r
art_number <- read_csv(system.file("extdata/demo_art_number.csv", package = "naomi"))
anc_testing <- read_csv(system.file("extdata/demo_anc_testing.csv", package = "naomi"))
```

Programme data

Spectrum PJNZ


```r
pjnz <- system.file("extdata/demo_mwi2019.PJNZ", package = "naomi")
spec <- extract_pjnz_naomi(pjnz)
```

# 2. Choose model areas and time points

The following are required to be provided to define the model state space:

* `scope`: A collection of `area_id`s defining the set of areas to be modelled.
   Usually this is simply national level, so the level 0 `area_id`.
* `level`: Area level at which to fit model.
* `quarter_id_t1`: The first time point for the model--approximately the midpoint
  of the household survey data used.
* `quarter_id_t2`: The second time point for the model--the current time for which
   estimates are needed.
* `quarter_id_t3`: The third time point for the model--the future projection for HIV
   estimates.



```r
scope <- "MWI"
level <- 4
calendar_quarter_t1 <- "CY2016Q1"
calendar_quarter_t2 <- "CY2018Q3"
calendar_quarter_t3 <- "CY2019Q4"
```

The following select data inputs to model fitting from the uploaded datasets.
Providing `NULL` for any will exclude that data source from model fitting.

* Multiple household survey may be used in fitting, but they must be rougly
  contemporaneous around `quarter_id_t1`.
* Only survey ART coverage or survey VLS should be included from a given survey,
  not both. ART coverage is preferred if both are available.
* `artnum_quarter_id_t1` and `artnum_quarter_id_t1` are the time point at
  which current on ART programme data will be used to estimte ART coverage.
  They are typically the same `quarter_id_t1` and `quarter_id_t2` if ART
  programme data are used.
* `anc_quarter_id_t1` and `anc_quarter_id_t2` are typically a range of 3-4 quarters.    Data will be aggregated over these quarters for a larger sample size. They
  will typically be consecutive quarters, though a quarter could be dropped for
  example if there were reporting problems known to affect a given quarter.
Survey IDs to include in fitting


```r
prev_survey_ids  <- c("DEMO2016PHIA", "DEMO2015DHS")
artcov_survey_ids  <- "DEMO2016PHIA"
vls_survey_ids <- NULL
recent_survey_ids <- "DEMO2016PHIA"

artnum_calendar_quarter_t1 <- "CY2016Q1"
artnum_calendar_quarter_t2 <- "CY2018Q3"

anc_clients_year2 <- 2018
anc_clients_year2_num_months <- 9

anc_prevalence_year1 <- 2016
anc_prevalence_year2 <- 2018

anc_art_coverage_year1 <- 2016
anc_art_coverage_year2 <- 2018
```

# 3. Review input data

# 4. Prepare model inputs
Setup the model


```r
naomi_mf <- naomi_model_frame(area_merged,
                              pop_agesex,
                              spec,
                              scope = scope,
                              level = level,
                              calendar_quarter_t1,
                              calendar_quarter_t2,
                              calendar_quarter_t3)
```

Prepare data inputs


```r
naomi_data <- select_naomi_data(naomi_mf,
                                survey_hiv_indicators,
                                anc_testing,
                                art_number,
                                prev_survey_ids,
                                artcov_survey_ids,
                                recent_survey_ids,
                                vls_survey_ids,
                                artnum_calendar_quarter_t1,
                                artnum_calendar_quarter_t2,
                                anc_prevalence_year1,
                                anc_prevalence_year2,
                                anc_art_coverage_year1,
                                anc_art_coverage_year2)
```

5. Fit model
Prepare model inputs and initial parameters


```r
tmb_inputs <- prepare_tmb_inputs(naomi_data)
```

Fit the TMB model


```r
fit <- fit_tmb(tmb_inputs)
#>   0:     5044.6435:  0.00000 0.916291  0.00000 0.916291  0.00000 0.916291  2.58200 0.916291 -0.693147  0.00000 0.916291  0.00000 0.916291  0.00000 0.916291  2.58200 0.916291 0.916291 0.916291 0.916291  0.00000  0.00000  0.00000 -0.693147 0.916291 0.916291 0.916291 0.916291 0.916291 0.916291
#>   1:     4718.2401: 0.102104 -0.277378 0.106313 -0.346451 0.0959817 0.605789  2.71841 0.570737 -0.693147 0.0869975 -0.139898 0.0757006 -0.0439938 0.0383274 0.469446  2.66560 0.681799 -0.108708 -0.217260 -0.147586 0.0152858 0.000608564 -0.297008 -1.75598 -0.359159 -0.234783 -0.377829 -0.0607581 0.549393 0.916291
#>   2:     4536.5945: 0.171715 -0.908226 0.222864 -1.73034 0.309508 0.371577  2.88605 0.176383 -0.693147 0.176493 -1.25119 0.149605 -0.965573 0.122804 -0.0458188  2.75526 0.440047 -1.14582 -1.25450 -1.34306 0.0290446 0.00106901 -0.806478 -1.22408 -1.75536 -1.34741 -2.02764 -0.973678 0.263750 0.916291
#>   3:     4516.5973: 0.150766 -0.451559 0.233584 -1.88128 0.423093 0.327143  2.93374 0.0696739 -0.693147 0.190409 -1.44460 0.170925 -1.21684 0.185843 -0.177630  2.78228 0.369285 -1.27483 -1.46360 -1.65162 0.0265142 0.00107495 -0.934666 -1.61733 -1.70318 -1.51764 -2.17708 -1.06033 0.311859 0.916291
#>   4:     4505.3198: 0.198961 -0.820169 0.246244 -2.06583 0.626263 0.244886  3.00218 -0.0817229 -0.693147 0.205657 -1.69493 0.196287 -1.49304 0.316633 -0.357516  2.82438 0.259138 -1.37776 -1.72848 -2.03305 0.0180307 0.00102736 -1.08664 -1.62993 -1.63599 -1.75304 -2.27554 -1.14966 0.284142 0.916291
#>   5:     4499.7002: 0.203603 -0.403248 0.250498 -2.06347  1.00437 0.0867395  3.07277 -0.235538 -0.693147 0.213589 -1.88266 0.207662 -1.55168 0.616741 -0.516800  2.88331 0.102089 -1.30180 -1.89843 -2.35695 -0.0108732 0.000797404 -1.11781 -1.51885 -1.69945 -1.96813 -2.13550 -1.10801 0.314535 0.916291
#>   6:     4493.1434: 0.264578 -0.582854 0.246978 -1.94966  1.54074 -0.0156313  3.10593 -0.297971 -0.693147 0.209057 -1.97423 0.201211 -1.33340  1.05354 -0.611314  2.92789 -0.0254007 -1.39386 -1.92865 -2.55196 -0.0505299 0.000457919 -1.15077 -1.72466 -1.66248 -2.02225 -2.36747 -1.05821 0.310786 0.916291
#>   7:     4491.4840: 0.284688 -0.667076 0.249776 -1.99542  1.68265 -0.0171180  3.10690 -0.295961 -0.693147 0.209382 -2.02866 0.211587 -1.43018  1.17120 -0.634781  2.92921 -0.0367056 -1.31269 -1.99463 -2.60384 -0.0609994 0.000379707 -1.20382 -1.50325 -1.65234 -2.04958 -2.30678 -1.13271 0.301414 0.916291
#>   8:     4489.8892: 0.298566 -0.599664 0.248760 -1.99548  1.88021 -0.0107554  3.10239 -0.279585 -0.693147 0.207269 -2.07235 0.217086 -1.45118  1.34087 -0.644462  2.92790 -0.0458389 -1.33464 -2.04963 -2.64592 -0.0778757 0.000251062 -1.24797 -1.72034 -1.65164 -2.05426 -2.30312 -1.08497 0.308454 0.916291
#>   9:     4488.2963: 0.325878 -0.631608 0.243486 -1.96815  2.09944 0.0105858  3.09756 -0.261508 -0.693147 0.202949 -2.11622 0.220029 -1.43154  1.53732 -0.637137  2.92255 -0.0504335 -1.31754 -2.11790 -2.69121 -0.101127 8.44504e-05 -1.28238 -1.54944 -1.64772 -2.05141 -2.34616 -1.07110 0.305600 0.916291
#>  10:     4487.7575: 0.388664 -0.660392 0.221642 -1.87564  2.50872 0.103606  3.11924 -0.291701 -0.693147 0.190559 -2.21829 0.221699 -1.34201  1.91488 -0.572812  2.91205 -0.0693696 -1.00761 -2.24506 -2.80416 -0.159424 -0.000335364 -1.40434 -1.65183 -1.69000 -2.05015 -2.44418 -1.15823 0.305188 0.916291
#>  11:     4484.8522: 0.444013 -0.607132 0.198628 -1.84251  2.87286 0.211211  3.13478 -0.307175 -0.693147 0.178256 -2.33561 0.233464 -1.38482  2.24711 -0.468643  2.89291 -0.0722049 -1.13104 -2.42167 -2.89370 -0.214745 -0.000724519 -1.58731 -1.67648 -1.66649 -2.05149 -2.43767 -0.773575 0.304663 0.916291
#>  12:     4483.9667: 0.504995 -0.600581 0.164077 -1.92779  3.17891 0.337337  3.12779 -0.262012 -0.693147 0.151022 -2.36313 0.235519 -1.34085  2.48073 -0.217720  2.86167 -0.0625951 -1.12980 -2.60417 -2.87489 -0.259481 -0.00105147 -2.02468 -1.66518 -1.48426 -1.97982 -2.35812 -0.869087 0.359607 0.916291
#>  13:     4483.4183: 0.513418 -0.626590 0.151477 -1.87182  3.20524 0.339829  3.13470 -0.273743 -0.693147 0.148989 -2.38158 0.242588 -1.43341  2.52619 -0.281641  2.85679 -0.0599623 -0.929314 -2.61686 -2.88132 -0.266965 -0.00109051 -2.02721 -1.55025 -1.63259 -1.99806 -2.41498 -0.844167 0.306716 0.916291
#>  14:     4482.9121: 0.543760 -0.624738 0.121214 -1.87244  3.34682 0.405307  3.14088 -0.270701 -0.693147 0.132215 -2.39037 0.243235 -1.43256  2.66283 -0.245828  2.83694 -0.0519441 -0.959624 -2.69989 -2.86961 -0.288228 -0.00117892 -2.20846 -1.64993 -1.63617 -1.96345 -2.41158 -0.787367 0.316451 0.916291
#>  15:     4482.8706: 0.544560 -0.605084 0.116422 -1.88395  3.36020 0.405912  3.14340 -0.273748 -0.693147 0.129484 -2.39123 0.242255 -1.42970  2.67145 -0.241858  2.83636 -0.0562511 -0.995418 -2.70150 -2.86639 -0.289132 -0.00115206 -2.21397 -1.59698 -1.61900 -1.96426 -2.41130 -0.792455 0.314787 0.916291
#>  16:     4482.8175: 0.554968 -0.610745 0.0989010 -1.88582  3.40090 0.419310  3.15023 -0.280751 -0.693147 0.121068 -2.39735 0.240910 -1.43655  2.70344 -0.224542  2.83270 -0.0659363 -0.985920 -2.70689 -2.85476 -0.295940 -0.00111565 -2.22797 -1.62218 -1.61025 -1.96801 -2.41418 -0.800554 0.307725 0.916291
#>  17:     4482.8043: 0.558910 -0.613156 0.0904497 -1.88509  3.41597 0.427701  3.15138 -0.279337 -0.693147 0.116849 -2.39663 0.238979 -1.42498  2.71767 -0.224134  2.83042 -0.0692325 -0.992721 -2.70697 -2.85151 -0.298173 -0.00109220 -2.22938 -1.62281 -1.61796 -1.96615 -2.40937 -0.794497 0.326248 0.916291
#>  18:     4482.7914: 0.562743 -0.609690 0.0814270 -1.88724  3.43336 0.435616  3.15274 -0.277883 -0.693147 0.112338 -2.39887 0.238070 -1.42720  2.73190 -0.218959  2.82722 -0.0715630 -0.983481 -2.70790 -2.84891 -0.300852 -0.00107166 -2.23201 -1.62136 -1.61427 -1.96813 -2.41120 -0.803982 0.308346 0.916291
#>  19:     4482.7449: 0.584322 -0.607264 0.0377000 -1.89387  3.52246 0.481781  3.15694 -0.264367 -0.693147 0.0897141 -2.41311 0.234242 -1.43381  2.80037 -0.162730  2.80747 -0.0756499 -0.975902 -2.72083 -2.84240 -0.315974 -0.00102182 -2.26359 -1.61235 -1.60578 -1.97093 -2.41500 -0.789379 0.316201 0.916291
#>  20:     4482.6990: 0.605688 -0.607273 -0.0150177 -1.88827  3.61472 0.508268  3.16790 -0.261711 -0.693147 0.0619168 -2.42157 0.227704 -1.42232  2.88532 -0.152975  2.78263 -0.0778996 -1.00192 -2.72713 -2.83055 -0.329552 -0.000933753 -2.27775 -1.62383 -1.62794 -1.96603 -2.40249 -0.795878 0.311480 0.916291
#>  21:     4482.6836: 0.612616 -0.604685 -0.0364309 -1.90582  3.64496 0.522527  3.17841 -0.272273 -0.693147 0.0482522 -2.42152 0.225473 -1.42544  2.92181 -0.154337  2.77434 -0.0872718 -0.977444 -2.72610 -2.82382 -0.334833 -0.000912918 -2.26900 -1.62479 -1.61526 -1.96379 -2.41842 -0.802801 0.324809 0.916291
#>  22:     4482.6650: 0.619066 -0.603839 -0.0653315 -1.89105  3.67110 0.546927  3.18911 -0.278762 -0.693147 0.0300408 -2.42230 0.222379 -1.42601  2.94941 -0.131975  2.76703 -0.108461 -0.987230 -2.72394 -2.82574 -0.338663 -0.000892029 -2.25417 -1.61766 -1.60703 -1.96949 -2.41526 -0.797123 0.315931 0.916291
#>  23:     4482.6599: 0.624950 -0.609791 -0.0885982 -1.91408  3.70778 0.539208  3.19052 -0.264693 -0.693147 0.0123634 -2.42142 0.219796 -1.42621  2.97320 -0.105280  2.75486 -0.117259 -0.992048 -2.71865 -2.82807 -0.341767 -0.000884125 -2.24339 -1.62721 -1.62205 -1.97053 -2.40350 -0.792207 0.312241 0.916291
#>  24:     4482.6473: 0.628892 -0.602340 -0.115560 -1.89628  3.73678 0.553056  3.19046 -0.245356 -0.693147 -0.00713997 -2.42354 0.218173 -1.43352  3.00789 -0.0931228  2.73310 -0.109194 -0.990992 -2.71701 -2.83383 -0.344557 -0.000890392 -2.24356 -1.62565 -1.62147 -1.97420 -2.41323 -0.804641 0.321498 0.916291
#>  25:     4482.6439: 0.629860 -0.609793 -0.117557 -1.90625  3.73316 0.568581  3.19557 -0.254218 -0.693147 -0.0100741 -2.42049 0.217124 -1.42192  3.01381 -0.0958555  2.73206 -0.112415 -0.989785 -2.71611 -2.83315 -0.344802 -0.000892618 -2.24287 -1.61562 -1.61344 -1.96994 -2.41058 -0.791156 0.309702 0.916291
#>  26:     4482.6370: 0.630602 -0.600430 -0.129122 -1.90344  3.74512 0.576682  3.20140 -0.257653 -0.693147 -0.0198932 -2.42131 0.216437 -1.42278  3.03099 -0.0910364  2.72348 -0.113691 -0.986381 -2.71622 -2.83422 -0.345776 -0.000896596 -2.24563 -1.62547 -1.61716 -1.96926 -2.41052 -0.799128 0.317972 0.916291
#>  27:     4482.6324: 0.632946 -0.603923 -0.141527 -1.90156  3.76179 0.571290  3.20772 -0.260548 -0.693147 -0.0314678 -2.42170 0.216146 -1.42845  3.04868 -0.0828372  2.71535 -0.119517 -0.988533 -2.71618 -2.83023 -0.346604 -0.000898536 -2.24825 -1.62053 -1.61385 -1.96865 -2.41061 -0.798570 0.317938 0.916291
#>  28:     4482.6288: 0.634674 -0.605467 -0.154351 -1.90576  3.77186 0.583009  3.20961 -0.252128 -0.693147 -0.0444645 -2.42154 0.215262 -1.42731  3.06739 -0.0751632  2.70627 -0.126053 -0.990724 -2.71530 -2.82989 -0.347246 -0.000898546 -2.24766 -1.62253 -1.61686 -1.96931 -2.41314 -0.797582 0.315278 0.916291
#>  29:     4482.6263: 0.635366 -0.602097 -0.167300 -1.90484  3.78438 0.587738  3.21429 -0.248724 -0.693147 -0.0585773 -2.42335 0.214356 -1.42280  3.08495 -0.0646448  2.69473 -0.129789 -0.985238 -2.71724 -2.83288 -0.347879 -0.000900817 -2.24963 -1.62125 -1.61606 -1.97046 -2.41040 -0.797251 0.315632 0.916291
#>  30:     4482.6237: 0.636037 -0.603393 -0.179310 -1.90639  3.79379 0.593168  3.22211 -0.250971 -0.693147 -0.0741204 -2.42485 0.214490 -1.42735  3.10374 -0.0561065  2.68146 -0.132499 -0.987494 -2.71451 -2.83064 -0.348068 -0.000897782 -2.24684 -1.62189 -1.61584 -1.97062 -2.40837 -0.798688 0.317031 0.916291
#>  31:     4482.6232: 0.636068 -0.604491 -0.179927 -1.90662  3.79498 0.591133  3.22224 -0.250034 -0.693147 -0.0753880 -2.42452 0.214450 -1.42627  3.10484 -0.0553934  2.68106 -0.134185 -0.988958 -2.71432 -2.83017 -0.347992 -0.000897395 -2.24671 -1.62293 -1.61553 -1.97019 -2.41111 -0.796935 0.316057 0.916291
#>  32:     4482.6230: 0.635841 -0.602949 -0.181153 -1.90661  3.79572 0.591110  3.22283 -0.249216 -0.693147 -0.0776018 -2.42436 0.214515 -1.42638  3.10702 -0.0544400  2.67986 -0.136091 -0.987269 -2.71409 -2.82957 -0.347904 -0.000896997 -2.24659 -1.62148 -1.61591 -1.97004 -2.41122 -0.798894 0.316720 0.916291
#>  33:     4482.6226: 0.635946 -0.604136 -0.182700 -1.90671  3.79668 0.591534  3.22370 -0.248708 -0.693147 -0.0801034 -2.42436 0.214563 -1.42649  3.10971 -0.0535004  2.67809 -0.137337 -0.988750 -2.71402 -2.82919 -0.347853 -0.000896453 -2.24652 -1.62276 -1.61563 -1.96990 -2.41125 -0.797517 0.316439 0.916291
#>  34:     4482.6200: 0.636409 -0.600473 -0.209823 -1.90805  3.81603 0.599107  3.23925 -0.243997 -0.693147 -0.120576 -2.42593 0.214908 -1.42755  3.15529 -0.0380339  2.64541 -0.148645 -0.991561 -2.71415 -2.82650 -0.347820 -0.000888415 -2.24581 -1.62247 -1.61347 -1.96806 -2.41343 -0.797884 0.318753 0.916291
#>  35:     4482.6181: 0.636171 -0.606960 -0.232296 -1.90872  3.82630 0.604777  3.25629 -0.238883 -0.693147 -0.164758 -2.42846 0.216531 -1.42751  3.19320 -0.0130564  2.61506 -0.173394 -0.987510 -2.71778 -2.82745 -0.346366 -0.000891503 -2.25052 -1.62264 -1.61749 -1.96879 -2.41179 -0.799770 0.317778 0.916291
#>  36:     4482.6171: 0.634939 -0.604384 -0.233438 -1.91047  3.82418 0.603528  3.25760 -0.231314 -0.693147 -0.175370 -2.42951 0.217601 -1.42752  3.19908 -0.0124774  2.60501 -0.172974 -0.987021 -2.71374 -2.82748 -0.345922 -0.000893031 -2.24927 -1.62258 -1.61492 -1.97226 -2.40928 -0.797333 0.316003 0.916291
#>  37:     4482.6170: 0.634815 -0.603378 -0.233088 -1.91018  3.82359 0.603554  3.25806 -0.231957 -0.693147 -0.175783 -2.42931 0.217649 -1.42634  3.19901 -0.0127523  2.60449 -0.172624 -0.988419 -2.71369 -2.82724 -0.345911 -0.000892962 -2.24913 -1.62218 -1.61578 -1.97129 -2.41124 -0.797122 0.316579 0.916291
#>  38:     4482.6169: 0.634805 -0.604139 -0.232329 -1.91020  3.82240 0.603021  3.25897 -0.232173 -0.693147 -0.177593 -2.42946 0.218061 -1.42638  3.19899 -0.0126087  2.60271 -0.172375 -0.987840 -2.71369 -2.82709 -0.345897 -0.000893293 -2.24872 -1.62263 -1.61582 -1.97043 -2.41128 -0.797661 0.316166 0.916291
#>  39:     4482.6165: 0.633530 -0.603616 -0.222709 -1.90956  3.80958 0.597243  3.26667 -0.230294 -0.693147 -0.196848 -2.42961 0.222701 -1.42817  3.19824 -0.0126174  2.58909 -0.181499 -0.987896 -2.71229 -2.82369 -0.345678 -0.000896609 -2.24677 -1.62305 -1.61551 -1.96707 -2.41092 -0.797818 0.315414 0.916291
#>  40:     4482.6163: 0.633533 -0.604724 -0.213727 -1.90807  3.79912 0.592716  3.27392 -0.226436 -0.693147 -0.217245 -2.42892 0.226948 -1.42639  3.19972 -0.0144000  2.57191 -0.184622 -0.987927 -2.71322 -2.82174 -0.345646 -0.000898554 -2.24881 -1.62223 -1.61591 -1.97019 -2.41095 -0.797682 0.316264 0.916291
#>  41:     4482.6162: 0.633566 -0.603756 -0.213569 -1.90881  3.79995 0.593029  3.27445 -0.226295 -0.693147 -0.218587 -2.42994 0.227152 -1.42623  3.19800 -0.0129870  2.57041 -0.183964 -0.988202 -2.71194 -2.82315 -0.345604 -0.000895500 -2.24842 -1.62241 -1.61622 -1.96999 -2.41125 -0.797354 0.316105 0.916291
#>  42:     4482.6162: 0.633842 -0.603737 -0.213605 -1.90882  3.80142 0.593726  3.27370 -0.225414 -0.693147 -0.217723 -2.43091 0.227097 -1.42639  3.19614 -0.0141685  2.57170 -0.185027 -0.988321 -2.71139 -2.82430 -0.345656 -0.000893628 -2.24824 -1.62238 -1.61602 -1.96857 -2.41130 -0.797609 0.316467 0.916291
#>  43:     4482.6162: 0.633969 -0.603871 -0.213436 -1.90897  3.80300 0.594565  3.27371 -0.225982 -0.693147 -0.217208 -2.43052 0.226997 -1.42616  3.19331 -0.0153377  2.57277 -0.185995 -0.988229 -2.71123 -2.82459 -0.345699 -0.000894071 -2.24788 -1.62240 -1.61596 -1.96982 -2.41122 -0.797699 0.316377 0.916291
#>  44:     4482.6162: 0.634135 -0.604026 -0.213383 -1.90877  3.80484 0.595462  3.27399 -0.226005 -0.693147 -0.217850 -2.43029 0.227134 -1.42623  3.19048 -0.0165643  2.57228 -0.185753 -0.988060 -2.71249 -2.82518 -0.345808 -0.000896704 -2.24809 -1.62226 -1.61601 -1.96910 -2.41098 -0.797489 0.316204 0.916291
#>  45:     4482.6162: 0.634165 -0.604052 -0.213386 -1.90858  3.80574 0.595515  3.27463 -0.225508 -0.693147 -0.219764 -2.43086 0.227389 -1.42624  3.18777 -0.0178481  2.57075 -0.185909 -0.988020 -2.71280 -2.82503 -0.345746 -0.000895806 -2.24805 -1.62251 -1.61597 -1.96950 -2.41131 -0.797613 0.316373 0.916291
#>  46:     4482.6162: 0.634093 -0.604026 -0.213633 -1.90884  3.80550 0.595571  3.27530 -0.225443 -0.693147 -0.221283 -2.43148 0.227555 -1.42616  3.18740 -0.0182836  2.56959 -0.186422 -0.988042 -2.71180 -2.82522 -0.345710 -0.000894135 -2.24877 -1.62236 -1.61602 -1.96941 -2.41134 -0.797490 0.316238 0.916291
#>  47:     4482.6162: 0.634086 -0.603891 -0.214035 -1.90890  3.80526 0.595506  3.27527 -0.225367 -0.693147 -0.221304 -2.43092 0.227476 -1.42615  3.18753 -0.0181305  2.56964 -0.186554 -0.988162 -2.71258 -2.82536 -0.345779 -0.000894570 -2.24796 -1.62239 -1.61595 -1.96944 -2.41124 -0.797572 0.316310 0.916291
#>  48:     4482.6162: 0.634100 -0.604000 -0.214139 -1.90879  3.80522 0.595416  3.27514 -0.225293 -0.693147 -0.221066 -2.43099 0.227431 -1.42628  3.18743 -0.0180144  2.56981 -0.186472 -0.988161 -2.71245 -2.82534 -0.345764 -0.000895707 -2.24812 -1.62236 -1.61606 -1.96951 -2.41126 -0.797609 0.316254 0.916291
#>  49:     4482.6162: 0.634095 -0.603942 -0.214150 -1.90882  3.80521 0.595423  3.27516 -0.225342 -0.693147 -0.221051 -2.43101 0.227421 -1.42622  3.18744 -0.0180827  2.56981 -0.186460 -0.988118 -2.71244 -2.82534 -0.345762 -0.000895642 -2.24816 -1.62243 -1.61603 -1.96948 -2.41126 -0.797571 0.316296 0.916291
#>  50:     4482.6162: 0.634099 -0.603961 -0.214209 -1.90883  3.80521 0.595430  3.27519 -0.225369 -0.693147 -0.221067 -2.43111 0.227412 -1.42618  3.18736 -0.0181435  2.56979 -0.186447 -0.988115 -2.71243 -2.82532 -0.345758 -0.000894928 -2.24814 -1.62240 -1.61600 -1.96948 -2.41127 -0.797566 0.316293 0.916291
#> converged: relative convergence (4)
```

Calculate model outputs. We can calculate outputs based on posterior mode
estimates before running `report_tmb()` to calculate posterior intervals.


```r
outputs <- output_package(fit, naomi_mf)
```

The output package consists of a data frame of indicators and metadata
defining the labels for each indicator.


```r
names(outputs)
#> [1] "indicators"     "art_attendance" "meta_area"      "meta_age_group"
#> [5] "meta_period"    "meta_indicator" "fit"
```

If uncertainty has not been calcualted yet, the output object retures values
for `mode`, but not `mean` or `lower` and `upper` 95% uncertainty ranges.


```r
outputs$indicators %>%
  dplyr::filter(
    indicator == "prevalence",  # HIV prevalence
    age_group == "Y015_049"   # Age group 15-49
  ) %>%
  head()
#> # A tibble: 6 x 11
#>   area_id sex   age_group calendar_quarter indicator  mean    se median   mode
#>   <chr>   <chr> <chr>     <chr>            <chr>     <dbl> <dbl>  <dbl>  <dbl>
#> 1 MWI     both  Y015_049  CY2016Q1         prevalen…    NA    NA     NA 0.0886
#> 2 MWI     fema… Y015_049  CY2016Q1         prevalen…    NA    NA     NA 0.111 
#> 3 MWI     male  Y015_049  CY2016Q1         prevalen…    NA    NA     NA 0.0659
#> 4 MWI_1_… both  Y015_049  CY2016Q1         prevalen…    NA    NA     NA 0.0668
#> 5 MWI_1_… fema… Y015_049  CY2016Q1         prevalen…    NA    NA     NA 0.0826
#> 6 MWI_1_… male  Y015_049  CY2016Q1         prevalen…    NA    NA     NA 0.0507
#> # … with 2 more variables: lower <dbl>, upper <dbl>
```

The function `add_output_labels()` returns the indicators table
with labels added as additional columns.


```r
add_output_labels(outputs) %>%
  dplyr::filter(
    indicator == "prevalence",  # HIV prevalence
    age_group == "Y015_049"   # Age group 15-49
  ) %>%
  head()
#> # A tibble: 6 x 17
#>   area_level area_level_label area_id area_name sex   age_group age_group_label
#>        <int> <chr>            <chr>   <chr>     <chr> <chr>     <chr>          
#> 1          0 Country          MWI     Malawi -… both  Y015_049  15-49          
#> 2          0 Country          MWI     Malawi -… fema… Y015_049  15-49          
#> 3          0 Country          MWI     Malawi -… male  Y015_049  15-49          
#> 4          0 Country          MWI     Malawi -… both  Y015_049  15-49          
#> 5          0 Country          MWI     Malawi -… fema… Y015_049  15-49          
#> 6          0 Country          MWI     Malawi -… male  Y015_049  15-49          
#> # … with 10 more variables: calendar_quarter <chr>, quarter_label <chr>,
#> #   indicator <chr>, indicator_label <chr>, mean <dbl>, se <dbl>, median <dbl>,
#> #   mode <dbl>, lower <dbl>, upper <dbl>
```

Calculate uncertainty ranges and add to the output object
(This is time consuming and memory intensive.


```r
system.time(fit <- sample_tmb(fit))
#>    user  system elapsed 
#>  14.173   1.665  15.848
```

Regenerate outputs with uncertainty ranges.


```r
system.time(outputs <- output_package(fit, naomi_mf))
#>    user  system elapsed 
#>  23.999   0.004  24.021

outputs_calib <- calibrate_outputs(outputs, naomi_mf,
                                   spectrum_plhiv_calibration_level = "national",
                                   spectrum_plhiv_calibration_strat = "sex_age_coarse",
                                   spectrum_artnum_calibration_level = "national", 
                                   spectrum_artnum_calibration_strat = "sex_age_coarse",
                                   spectrum_aware_calibration_level = "national", 
                                   spectrum_aware_calibration_strat = "sex_age_coarse",
                                   spectrum_infections_calibration_level = "national", 
                                   spectrum_infections_calibration_strat = "sex_age_coarse")


outputs$indicators %>%
  dplyr::filter(
    indicator == "prevalence",  # HIV prevalence
    age_group == "Y015_049"   # Age group 15-49
  ) %>%
  head()
#> # A tibble: 6 x 11
#>   area_id sex   age_group calendar_quarter indicator   mean      se median
#>   <chr>   <chr> <chr>     <chr>            <chr>      <dbl>   <dbl>  <dbl>
#> 1 MWI     both  Y015_049  CY2016Q1         prevalen… 0.0889 0.00131 0.0889
#> 2 MWI     fema… Y015_049  CY2016Q1         prevalen… 0.111  0.00199 0.111 
#> 3 MWI     male  Y015_049  CY2016Q1         prevalen… 0.0662 0.00201 0.0663
#> 4 MWI_1_… both  Y015_049  CY2016Q1         prevalen… 0.0671 0.00152 0.0671
#> 5 MWI_1_… fema… Y015_049  CY2016Q1         prevalen… 0.0830 0.00232 0.0830
#> 6 MWI_1_… male  Y015_049  CY2016Q1         prevalen… 0.0510 0.00197 0.0510
#> # … with 3 more variables: mode <dbl>, lower <dbl>, upper <dbl>
```

Save model outputs to ZIP


```r
dir.create("outputs", showWarnings = FALSE)
save_output_package(outputs, "demo_outputs", "outputs", with_labels = FALSE)
save_output_package(outputs, "demo_outputs_with_labels", "outputs", with_labels = TRUE)
save_output_package(outputs, "demo_outputs_single_csv", "outputs", with_labels = TRUE, single_csv = TRUE)
save_output_package(outputs, "demo_outputs_single_csv_unlabelled", "outputs", with_labels = FALSE, single_csv = TRUE)


## #' 6. Plot some model outputs

indicators <- add_output_labels(outputs) %>%
  left_join(outputs$meta_area %>% select(area_level, area_id, center_x, center_y)) %>%
  sf::st_as_sf()
```

15-49 prevalence by district


```r
indicators %>%
  filter(age_group == "Y015_049",
         indicator == "prevalence",
         area_level == 4) %>%
  ggplot(aes(fill = mode)) +
  geom_sf() +
  viridis::scale_fill_viridis(labels = scales::percent_format()) +
  th_map() +
  facet_wrap(~sex)
```

![plot of chunk prev_by_district_15](figure/prev_by_district_15-1.png)

15-49 prevalence by Zone



```r
indicators %>%
  filter(age_group == "Y015_049",
         ## sex == "both",
         indicator == "prevalence",
         area_level == 2) %>%
  ggplot(aes(fill = mean)) +
  geom_sf() +
  viridis::scale_fill_viridis(labels = scales::percent_format()) +
  th_map() +
  facet_wrap(~sex)
```

![plot of chunk prev_by_zone_15](figure/prev_by_zone_15-1.png)

Age-specific prevalence, national


```r
indicators %>%
  dplyr::filter(area_level == 0,
         sex != "both",
         age_group %in% get_five_year_age_groups(),
         calendar_quarter == "CY2018Q3",
         indicator == "prevalence") %>%
  left_join(get_age_groups()) %>%
  mutate(age_group = fct_reorder(age_group_label, age_group_sort_order)) %>%
  ggplot(aes(age_group, mean, ymin = lower, ymax = upper, fill = sex)) +
  geom_col(position = "dodge") +
  geom_linerange(position = position_dodge(0.8)) +
  scale_fill_brewer(palette = "Set1") +
  scale_y_continuous(labels = scales::percent_format(1)) +
  facet_wrap(~area_name) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0.5))
#> Joining, by = c("age_group", "age_group_label")
```

![plot of chunk age_specific_prev](figure/age_specific_prev-1.png)

15-64 ART coverage by district


```r
indicators %>%
  filter(age_group == "Y015_064",
         area_level == 4,
         indicator == "art_coverage") %>%
  ggplot(aes(fill = mean)) +
  geom_sf() +
  viridis::scale_fill_viridis(labels = scales::percent_format()) +
  th_map() +
  facet_wrap(~sex)
```

![plot of chunk art_cov_district](figure/art_cov_district-1.png)

Age-specific ART coverage, national


```r
indicators %>%
  dplyr::filter(area_level == 0,
         sex != "both",
         age_group %in% get_five_year_age_groups(),
         indicator == "art_coverage",
         calendar_quarter == "CY2018Q3") %>%
  left_join(get_age_groups()) %>%
  mutate(age_group = fct_reorder(age_group_label, age_group_sort_order)) %>%
  ggplot(aes(age_group, mean, ymin = lower, ymax = upper, fill = sex)) +
  geom_col(position = "dodge") +
  geom_linerange(position = position_dodge(0.8)) +
  scale_fill_brewer(palette = "Set1") +
  scale_y_continuous(labels = scales::percent_format(1)) +
  facet_wrap(~calendar_quarter) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0.5))
#> Joining, by = c("age_group", "age_group_label")
```

![plot of chunk age_specific_art_cov](figure/age_specific_art_cov-1.png)

ART coverage by age/sex and region



```r
indicators %>%
  filter(area_level == 1,
         sex != "both",
         age_group %in% get_five_year_age_groups(),
         indicator == "art_coverage",
         calendar_quarter == "CY2018Q3") %>%
  left_join(get_age_groups()) %>%
  mutate(age_group = fct_reorder(age_group_label, age_group_sort_order)) %>%
  ggplot(aes(age_group, mean, ymin = lower, ymax = upper, fill = sex)) +
  geom_col(position = "dodge") +
  geom_linerange(position = position_dodge(0.8)) +
  scale_fill_brewer(palette = "Set1") +
  scale_y_continuous(labels = scales::percent_format(1)) +
  facet_wrap(~area_name) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0.5))
#> Joining, by = c("age_group", "age_group_label")
```

![plot of chunk art_cov_age_sex](figure/art_cov_age_sex-1.png)

Bubble plot prevalence and PLHIV



```r
indicators %>%
  filter(age_group == "Y015_064",
         area_level == 4,
         indicator %in% c("prevalence", "plhiv"),
         calendar_quarter == "CY2018Q3") %>%
  select(sex, center_x, center_y, indicator_label, mean) %>%
  spread(indicator_label, mean) %>%
  ggplot() +
  geom_sf() +
  geom_point(aes(center_x, center_y, colour = `HIV prevalence`, size = PLHIV)) +
  viridis::scale_color_viridis(labels = scales::percent_format()) +
  th_map() +
  facet_wrap(~sex)
```

![plot of chunk bubble_plot](figure/bubble_plot-1.png)

